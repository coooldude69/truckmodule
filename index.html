<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Status Update App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
</head>
<body class="bg-gray-100 font-roboto">
    <div class="container mx-auto p-4">
        <!-- Header Section -->
        <div class="flex justify-between items-center bg-blue-600 text-white p-4 rounded-lg shadow-lg mb-4">
            <div class="flex items-center">
                <div class="h-16 w-16 mr-4 bg-white rounded-full flex items-center justify-center">
                    <span class="text-blue-600 text-2xl font-bold">TMS</span>
                </div>
                <div>
                    <h1 class="text-3xl font-bold">Truck Status Update</h1>
                    <p class="text-md mt-1">Manage and track the status of trucks efficiently</p>
                </div>
            </div>
            <div>
                <label for="datePicker" class="block text-md font-semibold">Select Date:</label>
                <input type="date" id="datePicker" class="p-2 border border-gray-300 rounded text-gray-700">
            </div>
        </div>

        <!-- Status Counters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Reported Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="reportedCount">0</p>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Filling Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="fillingCount">0</p>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Left Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="leftCount">0</p>
            </div>
        </div>

        <!-- Action Panels -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Report Panel -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Report Truck</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearchReport" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButtonReport">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumberReport"></select>
                </div>
                <div class="flex space-x-2">
                    <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="reportTruckButton">Report Truck</button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 w-full" id="reportIssueButton">Report Issue</button>
                </div>
                <p class="text-green-600 mt-2 hidden" id="reportConfirmationMessage">Truck reported successfully!</p>
                <p class="text-red-600 mt-2 hidden" id="issueConfirmationMessage">Issue reported successfully!</p>
            </div>
            <!-- Announce Panel -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Announce Truck</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearchAnnounce" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButtonAnnounce">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumberAnnounce"></select>
                </div>
                <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="announceTruckButton">Announce Truck</button>
                <p class="text-green-600 mt-2 hidden" id="announceConfirmationMessage">Truck announced successfully!</p>
            </div>
        </div>

        <!-- Details and History -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Truck Details -->
            <div class="bg-white p-4 rounded-lg shadow-lg h-full">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Truck Details</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearch" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumber"></select>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Owner Name:</label>
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="ownerName" readonly>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Owner Contact:</label>
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="ownerContact" readonly>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Retail Outlet:</label>
                    <div class="flex items-center mb-2">
                        <input type="text" class="w-full p-1 border border-gray-300 rounded" id="retailOutletSearch" placeholder="Search Retail Outlet">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchRetailOutletButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select class="w-full p-1 border border-gray-300 rounded" id="retailOutlet"></select>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Status:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="status">
                        <option value="filling">Filling</option>
                        <option value="left">Left</option>
                    </select>
                </div>
                <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="updateStatusButton">Update Status</button>
                <p class="text-green-600 mt-2 hidden" id="confirmationMessage">Status updated successfully!</p>
            </div>

            <!-- History Log -->
            <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col h-full">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">History Log</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="historySearch" placeholder="Search Truck Number in History">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchHistoryButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2 flex items-center justify-between">
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterAll">All</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterReported">Reported</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterFilling">Filling</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterLeft">Left</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterIssue">Issue</button>
                </div>
                <div class="overflow-y-auto flex-grow border border-gray-300 rounded p-2" id="historyLogContainer" style="max-height: 300px;">
                    <ul class="list-disc pl-5 text-sm" id="historyLog"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Remarks Modal -->
    <div id="issueRemarksModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-4 rounded-lg shadow-lg w-1/3">
            <h2 class="text-xl font-semibold mb-2 text-gray-800">Report Issue</h2>
            <div class="mb-2">
                <label class="block text-gray-700">Remarks:</label>
                <textarea class="w-full p-1 border border-gray-300 rounded" id="modalIssueRemarks" placeholder="Describe the issue..."></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600" id="cancelIssueButton">Cancel</button>
                <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" id="submitIssueButton">Submit</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Config
        const CONFIG = {
            SUPABASE_URL: 'https://frahxyaqumgoobzdgghb.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyYWh4eWFxdW1nb29iemRnZ2hiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE2Nzc1OTQsImV4cCI6MjA0NzI1MzU5NH0.vnxynX6ixnDqVUBnQkH2w8Q-fc50CbbCMyqelrjiDbU',
            CALLMEBOT_API_KEY: 'YOUR_CALLMEBOT_API_KEY',
            GROUP_PHONE_NUMBER: 'YOUR_GROUP_PHONE_NUMBER'
        };

        // Initialize Supabase Client
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        // Global state
        let currentTruckData = null;
        const reportedTrucks = new Set();

        // Initialize date picker
        document.getElementById('datePicker').valueAsDate = new Date();

        // Main initialization function
        async function initialize() {
            try {
                console.log('Starting initialization...');
                
                // Test Supabase connection first
                const { data: testConnection, error: connectionError } = await supabase
                    .from('trucks')
                    .select('count');
                
                if (connectionError) {
                    throw new Error(`Supabase connection test failed: ${connectionError.message}`);
                }
                
                console.log('Supabase connection successful');

                // Load data sequentially with error handling
                await loadTrucks();
                await loadRetailOutlets();
                await updateStatusCounts();
                await updateHistoryLog();

                // Set up real-time subscription
                setupRealtimeSubscription();

                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
                showError(`Failed to initialize application: ${error.message}`);
            }
        }

        // Setup real-time subscription
        function setupRealtimeSubscription() {
            const statusUpdates = supabase
                .channel('status_updates')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'status_updates'
                }, payload => {
                    console.log('Received real-time update:', payload);
                    updateStatusCounts();
                   updateHistoryLog();
                })
                .subscribe();
        }

        // Load trucks from Supabase
        async function loadTrucks() {
            try {
                const { data: trucks, error } = await supabase
                    .from('trucks')
                    .select('*')
                    .order('truck_number');

                if (error) throw error;

                const truckSelects = document.querySelectorAll('#truckNumber, #truckNumberReport, #truckNumberAnnounce');
                truckSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Truck</option>';
                    trucks.forEach(truck => {
                        const option = document.createElement('option');
                        option.value = truck.id;
                        option.textContent = truck.truck_number;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading trucks:', error);
                showError('Failed to load trucks');
            }
        }

        // Load retail outlets from Supabase
        async function loadRetailOutlets() {
            try {
                const { data: outlets, error } = await supabase
                    .from('retail_outlets')
                    .select('*')
                    .order('name');

                if (error) throw error;

                const retailSelect = document.getElementById('retailOutlet');
                retailSelect.innerHTML = '<option value="">Select Retail Outlet</option>';
                outlets.forEach(outlet => {
                    const option = document.createElement('option');
                    option.value = outlet.id;
                    option.textContent = outlet.name;
                    retailSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading retail outlets:', error);
                showError('Failed to load retail outlets');
            }
        }

        // Update status counts
        async function updateStatusCounts() {
            try {
                const today = document.getElementById('datePicker').value;
                const startOfDay = new Date(today);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(today);
                endOfDay.setHours(23, 59, 59, 999);

                const { data: statusCounts, error } = await supabase
                    .from('status_updates')
                    .select('status')
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString());

                if (error) throw error;

                const counts = {
                    reported: 0,
                    filling: 0,
                    left: 0
                };

                statusCounts.forEach(update => {
                    if (update.status in counts) {
                        counts[update.status]++;
                    }
                });

                document.getElementById('reportedCount').textContent = counts.reported;
                document.getElementById('fillingCount').textContent = counts.filling;
                document.getElementById('leftCount').textContent = counts.left;
            } catch (error) {
                console.error('Error updating status counts:', error);
                showError('Failed to update status counts');
            }
        }

        // Update history log
        async function updateHistoryLog(filter = 'all', searchTerm = '') {
            try {
                let query = supabase
                    .from('status_updates')
                    .select(`
                        *,
                        trucks (truck_number),
                        retail_outlets (name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (filter !== 'all') {
                    query = query.eq('status', filter);
                }

                if (searchTerm) {
                    query = query.textSearch('trucks.truck_number', searchTerm);
                }

                const { data: history, error } = await query;

                if (error) throw error;

                const historyLog = document.getElementById('historyLog');
                historyLog.innerHTML = '';

                history.forEach(entry => {
                    const li = document.createElement('li');
                    const timestamp = new Date(entry.created_at).toLocaleString();
                    const truckNumber = entry.trucks?.truck_number || 'Unknown Truck';
                    const retailOutlet = entry.retail_outlets?.name || 'Unknown Outlet';
                    
                    let statusClass = '';
                    switch (entry.status) {
                        case 'reported': statusClass = 'text-blue-600'; break;
                        case 'filling': statusClass = 'text-green-600'; break;
                        case 'left': statusClass = 'text-red-600'; break;
                        case 'issue': statusClass = 'text-yellow-600'; break;
                    }

                    li.className = `mb-2 ${statusClass}`;
                    li.innerHTML = `
                        <span class="font-semibold">${timestamp}</span> - 
                        Truck ${truckNumber} 
                        ${entry.status === 'issue' 
                            ? `reported issue: ${entry.remarks}`
                            : `${entry.status} ${entry.status !== 'reported' ? 'at ' + retailOutlet : ''}`}
                    `;
                    historyLog.appendChild(li);
                });
            } catch (error) {
                console.error('Error updating history log:', error);
                showError('Failed to update history log');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initialize();

            // Date picker change
            document.getElementById('datePicker').addEventListener('change', updateStatusCounts);

            // Truck search functionality
            setupTruckSearch('truckSearch', 'truckNumber');
            setupTruckSearch('truckSearchReport', 'truckNumberReport');
            setupTruckSearch('truckSearchAnnounce', 'truckNumberAnnounce');

            // Retail outlet search
            setupRetailOutletSearch();

            // Status update button
            document.getElementById('updateStatusButton').addEventListener('click', updateTruckStatus);

            // Report and announce buttons
            document.getElementById('reportTruckButton').addEventListener('click', reportTruck);
            document.getElementById('announceTruckButton').addEventListener('click', announceTruck);
            document.getElementById('reportIssueButton').addEventListener('click', showIssueModal);

            // Issue modal buttons
            document.getElementById('submitIssueButton').addEventListener('click', submitIssue);
            document.getElementById('cancelIssueButton').addEventListener('click', hideIssueModal);

            // History filters
            setupHistoryFilters();
        });

        // Setup truck search functionality
        function setupTruckSearch(searchId, selectId) {
            const searchInput = document.getElementById(searchId);
            const searchButton = searchInput.nextElementSibling;
            const select = document.getElementById(selectId);

            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                Array.from(select.options).forEach(option => {
                    const matches = option.text.toLowerCase().includes(searchTerm);
                    option.style.display = matches ? '' : 'none';
                });
            });
        }

        // Setup retail outlet search
        function setupRetailOutletSearch() {
            const searchInput = document.getElementById('retailOutletSearch');
            const searchButton = document.getElementById('searchRetailOutletButton');
            const select = document.getElementById('retailOutlet');

            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                Array.from(select.options).forEach(option => {
                    const matches = option.text.toLowerCase().includes(searchTerm);
                    option.style.display = matches ? '' : 'none';
                });
            });
        }

        // Setup history filters
        function setupHistoryFilters() {
            const filterButtons = ['filterAll', 'filterReported', 'filterFilling', 'filterLeft', 'filterIssue'];
            filterButtons.forEach(buttonId => {
                document.getElementById(buttonId).addEventListener('click', () => {
                    const filter = buttonId.replace('filter', '').toLowerCase();
                    const searchTerm = document.getElementById('historySearch').value;
                    updateHistoryLog(filter, searchTerm);
                });
            });

            document.getElementById('searchHistoryButton').addEventListener('click', () => {
                const searchTerm = document.getElementById('historySearch').value;
                updateHistoryLog('all', searchTerm);
            });
        }

        // Error handling function
        function showError(message) {
            // You can implement your preferred error display method here
            console.error(message);
            alert(message);
        }

        // Success message handling
        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 3000);
        }

        // Modal handling
        function showIssueModal() {
            document.getElementById('issueRemarksModal').classList.remove('hidden');
        }

        function hideIssueModal() {
            document.getElementById('issueRemarksModal').classList.add('hidden');
            document.getElementById('modalIssueRemarks').value = '';
        }

        // Initialize the application
        initialize();
    </script>
</body>
</html>
