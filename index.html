<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Status Update App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-roboto">
    <div class="container mx-auto p-4">
        <!-- Header Section -->
        <div class="flex justify-between items-center bg-blue-600 text-white p-4 rounded-lg shadow-lg mb-4">
            <div class="flex items-center">
                <div class="h-16 w-16 mr-4 bg-white rounded-full flex items-center justify-center">
                    <span class="text-blue-600 text-2xl font-bold">TMS</span>
                </div>
                <div>
                    <h1 class="text-3xl font-bold">Truck Status Update</h1>
                    <p class="text-md mt-1">Manage and track the status of trucks efficiently</p>
                </div>
            </div>
            <div>
                <label for="datePicker" class="block text-md font-semibold">Select Date:</label>
                <input type="date" id="datePicker" class="p-2 border border-gray-300 rounded text-gray-700">
            </div>
        </div>

        <!-- Status Counters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Reported Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="reportedCount">0</p>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Filling Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="fillingCount">0</p>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-lg text-center">
                <h3 class="text-md font-semibold text-gray-800">Left Trucks</h3>
                <p class="text-xl font-bold text-blue-600" id="leftCount">0</p>
            </div>
        </div>

        <!-- Action Panels -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Report Panel -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Report Truck</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearchReport" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButtonReport">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumberReport"></select>
                </div>
                <div class="flex space-x-2">
                    <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="reportTruckButton">Report Truck</button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 w-full" id="reportIssueButton">Report Issue</button>
                </div>
                <p class="text-green-600 mt-2 hidden" id="reportConfirmationMessage">Truck reported successfully!</p>
                <p class="text-red-600 mt-2 hidden" id="issueConfirmationMessage">Issue reported successfully!</p>
            </div>
            <!-- Announce Panel -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Announce Truck</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearchAnnounce" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButtonAnnounce">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumberAnnounce"></select>
                </div>
                <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="announceTruckButton">Announce Truck</button>
                <p class="text-green-600 mt-2 hidden" id="announceConfirmationMessage">Truck announced successfully!</p>
            </div>
        </div>

        <!-- Details and History -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Truck Details -->
            <div class="bg-white p-4 rounded-lg shadow-lg h-full">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Truck Details</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="truckSearch" placeholder="Search Truck Number">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchTruckButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Truck Number:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="truckNumber"></select>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Owner Name:</label>
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="ownerName" readonly>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Owner Contact:</label>
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="ownerContact" readonly>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Retail Outlet:</label>
                    <div class="flex items-center mb-2">
                        <input type="text" class="w-full p-1 border border-gray-300 rounded" id="retailOutletSearch" placeholder="Search Retail Outlet">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchRetailOutletButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select class="w-full p-1 border border-gray-300 rounded" id="retailOutlet"></select>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700">Status:</label>
                    <select class="w-full p-1 border border-gray-300 rounded" id="status">
                        <option value="filling">Filling</option>
                        <option value="left">Left</option>
                    </select>
                </div>
                <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 w-full" id="updateStatusButton">Update Status</button>
                <p class="text-green-600 mt-2 hidden" id="confirmationMessage">Status updated successfully!</p>
            </div>

            <!-- History Log -->
            <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col h-full">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">History Log</h2>
                <div class="mb-2 flex items-center">
                    <input type="text" class="w-full p-1 border border-gray-300 rounded" id="historySearch" placeholder="Search Truck Number in History">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2 hover:bg-blue-600" id="searchHistoryButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mb-2 flex items-center justify-between">
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterAll">All</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterReported">Reported</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterFilling">Filling</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterLeft">Left</button>
                    <button class="bg-gray-200 text-gray-800 px-2 py-1 rounded hover:bg-gray-300" id="filterIssue">Issue</button>
                </div>
                <div class="overflow-y-auto flex-grow border border-gray-300 rounded p-2" id="historyLogContainer" style="max-height: 300px;">
                    <ul class="list-disc pl-5 text-sm" id="historyLog"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Remarks Modal -->
    <div id="issueRemarksModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-4 rounded-lg shadow-lg w-1/3">
            <h2 class="text-xl font-semibold mb-2 text-gray-800">Report Issue</h2>
            <div class="mb-2">
                <label class="block text-gray-700">Remarks:</label>
                <textarea class="w-full p-1 border border-gray-300 rounded" id="modalIssueRemarks" placeholder="Describe the issue..."></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600" id="cancelIssueButton">Cancel</button>
                <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" id="submitIssueButton">Submit</button>
            </div>
        </div>
    </div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, enableLogging } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    enableLogging(true);
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDQq9lVJ-Gsbx4EGmyexfG4uTMkw6fnIsU",
          authDomain: "truck-status-update.firebaseapp.com",
          projectId: "truck-status-update",
          storageBucket: "truck-status-update.firebasestorage.app",
          messagingSenderId: "1033300381667",
          appId: "1:1033300381667:web:8e12891bdf64aa4e239ad6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        console.log("Firebase initialized successfully");
    
// Global state
let trucks = {};
let reportedTrucks = new Set();

// Initialize app
async function init() {
    document.getElementById('datePicker').valueAsDate = new Date();
    await loadData();
    setupListeners();
}

// Load initial data
async function loadData() {
    try {
        const [trucksSnapshot, outletsSnapshot] = await Promise.all([
            db.ref('trucks').once('value'),
            db.ref('retail_outlets').once('value')
        ]);

        // Process trucks
        trucks = {};
        const truckOptions = [];
        trucksSnapshot.forEach(snap => {
            trucks[snap.key] = snap.val();
            truckOptions.push(`<option value="${snap.key}">${snap.val().truck_number}</option>`);
        });

        ['truckNumber', 'truckNumberReport', 'truckNumberAnnounce']
            .forEach(id => document.getElementById(id).innerHTML = truckOptions.join(''));

        // Process outlets
        const outletOptions = [];
        outletsSnapshot.forEach(snap => {
            outletOptions.push(`<option value="${snap.key}">${snap.val().outlet_name}</option>`);
        });
        document.getElementById('retailOutlet').innerHTML = outletOptions.join('');

        await updateStatus();
    } catch (error) {
        showToast('Failed to load data', 'error');
    }
}

// Update status counts and history
async function updateStatus() {
    const date = document.getElementById('datePicker').value;
    try {
        const snapshot = await db.ref('status_updates')
            .orderByChild('date')
            .equalTo(date)
            .once('value');

        const updates = [];
        reportedTrucks.clear();
        
        snapshot.forEach(snap => {
            const update = snap.val();
            updates.push(update);
            if(update.status === 'reported') reportedTrucks.add(update.truck_id);
        });

        // Update counters
        document.getElementById('reportedCount').textContent = reportedTrucks.size;
        document.getElementById('fillingCount').textContent = updates.filter(u => u.status === 'filling').length;
        document.getElementById('leftCount').textContent = updates.filter(u => u.status === 'left').length;

        // Update history
        updateHistory(updates);
    } catch (error) {
        showToast('Failed to update status', 'error');
    }
}

// Update history log
function updateHistory(updates) {
    const historyHtml = updates
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .map(update => {
            const time = new Date(update.created_at).toLocaleTimeString();
            const truck = trucks[update.truck_id]?.truck_number;
            const status = {
                'reported': 'Reported for loading',
                'filling': 'Started filling',
                'left': 'Left the terminal',
                'issue': `Issue reported: ${update.remarks}`
            }[update.status];

            return `<li class="mb-2">
                <span class="text-gray-500">${time}</span> - 
                <span class="font-semibold">${truck}</span> - 
                ${status}
            </li>`;
        })
        .join('');

    document.getElementById('historyLog').innerHTML = historyHtml;
}

// Setup event listeners
function setupListeners() {
    // Date change
    document.getElementById('datePicker').addEventListener('change', updateStatus);

    // Report truck
    document.getElementById('reportTruckButton').addEventListener('click', async () => {
        const truckId = document.getElementById('truckNumberReport').value;
        if (reportedTrucks.has(truckId)) {
            showToast('Truck already reported today', 'error');
            return;
        }

        try {
            await db.ref('status_updates').push({
                truck_id: truckId,
                status: 'reported',
                date: document.getElementById('datePicker').value,
                created_at: new Date().toISOString()
            });
            showToast('Truck reported successfully', 'success');
        } catch (error) {
            showToast('Failed to report truck', 'error');
        }
    });

    // Status update
    document.getElementById('updateStatusButton').addEventListener('click', async () => {
        const truckId = document.getElementById('truckNumber').value;
        const status = document.getElementById('status').value;
        const retailOutletId = document.getElementById('retailOutlet').value;

        try {
            await db.ref('status_updates').push({
                truck_id: truckId,
                retail_outlet_id: retailOutletId,
                status: status,
                date: document.getElementById('datePicker').value,
                created_at: new Date().toISOString()
            });
            showToast('Status updated successfully', 'success');
        } catch (error) {
            showToast('Failed to update status', 'error');
        }
    });

    // Search functionality
    setupSearch('truckSearch', 'truckNumber');
    setupSearch('truckSearchReport', 'truckNumberReport');
    setupSearch('truckSearchAnnounce', 'truckNumberAnnounce');
    setupSearch('retailOutletSearch', 'retailOutlet');
}

// Search helper
function setupSearch(searchId, selectId) {
    document.getElementById(searchId).addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        Array.from(document.getElementById(selectId).options)
            .forEach(option => {
                option.style.display = option.text.toLowerCase().includes(query) ? '' : 'none';
            });
    });
}

// Toast helper
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
    } text-white`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
